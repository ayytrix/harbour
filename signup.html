<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Harbour News Network - Sign Up</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ayytrix/harbour/refs/heads/main/ChatGPT%20Image%20Oct%2027%2C%202025%2C%2011_00_04%20AM.png">
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; color:#222; font-size:14px; }
  #main-header { background:linear-gradient(to bottom,#2c6aa5 0%,#1a3d66 100%); padding:10px 20px; display:flex; align-items:center; border-bottom:2px solid #071b36; }
  #main-header img { height:50px; }
  #notice { background:linear-gradient(to bottom,#ff9800 0%,#e68a00 100%); color:white; padding:10px 20px; font-weight:bold; text-align:center; border-bottom:2px solid #b36b00; }
  #page-content { padding:40px; display:flex; justify-content:center; }
  .signup-box { background:#fff; border:2px solid #999; box-shadow:2px 2px 0 #aaa; padding:25px 35px; width:400px; border-radius:6px; }
  .signup-box h2 { text-align:center; font-size:16px; margin-bottom:20px; border-bottom:1px solid #aaa; padding-bottom:8px; }
  .signup-box label { display:block; font-weight:bold; margin-bottom:5px; }
  .signup-box input { width:100%; padding:8px; margin-bottom:10px; border:1px solid #999; border-radius:3px; font-size:13px; }
  .signup-box button { width:100%; padding:10px; background:linear-gradient(to bottom,#2c6aa5 0%,#1a3d66 100%); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:10px; }
  .signup-box button:hover { background:linear-gradient(to bottom,#3b7ebc 0%,#1e426d 100%); }
  .error-message { color:red; font-size:12px; margin-top:-5px; margin-bottom:10px; display:none; }
</style>
</head>
<body>

<div id="main-header">
  <img src="https://raw.githubusercontent.com/ayytrix/harbour/refs/heads/main/ChatGPT%20Image%20Oct%2027%2C%202025%2C%2011_00_04%20AM.png" alt="Harbour News Network">
</div>

<div id="notice">Loading...</div>

<div id="page-content">
  <div class="signup-box">
    <h2>Sign Up</h2>
    <form id="signupForm">
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Choose a username" required>
      <div id="usernameError" class="error-message"></div>

      <label for="email">Email (Optional)</label>
      <input type="email" id="email" placeholder="Enter your email">

      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Create a password" required>

      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" placeholder="Re-enter your password" required>
      <div id="passwordError" class="error-message"></div>

      <button type="submit" id="signupBtn" disabled>Create Account</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, query, collection, getDocs, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAGtMifXSvavxsk8VLBsJAbrYJxOFs2oes",
    authDomain: "harbour-45dca.firebaseapp.com",
    projectId: "harbour-45dca",
    storageBucket: "harbour-45dca.firebasestorage.app",
    messagingSenderId: "109842774901",
    appId: "1:109842774901:web:0679722f1614ce82bd713c",
    measurementId: "G-5JBGJFKWM1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const usernameInput = document.getElementById("username");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const confirmPassword = document.getElementById("confirm-password");
  const usernameError = document.getElementById("usernameError");
  const passwordError = document.getElementById("passwordError");
  const signupBtn = document.getElementById("signupBtn");

  let isUsernameValid = false;
  let isPasswordValid = false;

  // Dynamic notice
  fetch("https://raw.githubusercontent.com/ayytrix/ventest1/refs/heads/main/anc")
    .then(r => r.ok ? r.text() : "Welcome to Harbour News Network!")
    .then(text => document.getElementById("notice").textContent = text)
    .catch(() => document.getElementById("notice").textContent = "Welcome to Harbour News Network!");

  // Password validation
  function checkPasswords() {
    if(passwordInput.value.length < 6){
      passwordError.style.display="block";
      passwordError.textContent="Password must be at least 6 characters.";
      isPasswordValid=false;
    } else if(passwordInput.value!==confirmPassword.value){
      passwordError.style.display="block";
      passwordError.textContent="Passwords do not match.";
      isPasswordValid=false;
    } else {
      passwordError.style.display="none";
      isPasswordValid=true;
    }
    signupBtn.disabled = !(isUsernameValid && isPasswordValid);
  }
  passwordInput.addEventListener("input", checkPasswords);
  confirmPassword.addEventListener("input", checkPasswords);

  // Username validation
  async function checkUsername() {
    const username = usernameInput.value.trim();
    isUsernameValid = false;
    if(username.length < 3 || username.length > 20){
      usernameError.textContent="Username must be 3â€“20 characters.";
      usernameError.style.display="block";
    } else {
      const regex=/^[a-zA-Z0-9_ ]+$/;
      if(!regex.test(username)){
        usernameError.textContent="Invalid characters.";
        usernameError.style.display="block";
      } else {
        const q=query(collection(db,"users"),where("username","==",username));
        const snapshot = await getDocs(q);
        if(!snapshot.empty){
          usernameError.textContent="Username taken.";
          usernameError.style.display="block";
        } else {
          usernameError.style.display="none";
          isUsernameValid=true;
        }
      }
    }
    signupBtn.disabled = !(isUsernameValid && isPasswordValid);
  }
  usernameInput.addEventListener("input", checkUsername);

  async function getNextUserId(){
    const q=query(collection(db,"users"),orderBy("userId","desc"),limit(1));
    const snapshot = await getDocs(q);
    return !snapshot.empty ? snapshot.docs[0].data().userId + 1 : 1;
  }

  document.getElementById("signupForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!isUsernameValid || !isPasswordValid) return;

    const username=usernameInput.value.trim();
    const email=emailInput.value.trim();
    const password=passwordInput.value;

    signupBtn.disabled=true;
    signupBtn.textContent="Creating Account...";

    try {
      const timestamp=Date.now();
      const uniqueEmail = email || `${username.toLowerCase()}_${timestamp}@harbour.local`;
      const userCredential = await createUserWithEmailAndPassword(auth, uniqueEmail, password);
      const user = userCredential.user;
      const userId = await getNextUserId();

      await setDoc(doc(db,"users",user.uid),{
        username,
        email: email || null,
        createdAt: new Date().toISOString(),
        userId
      });

      window.location.href="Home.html";
    } catch(err){
      console.error(err);
      alert("Error: " + (err.message || JSON.stringify(err)));
      signupBtn.disabled=false;
      signupBtn.textContent="Create Account";
    }
  });
</script>
</body>
</html>
